<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coral Subdivision - Real Estate Parcel Viewer</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .container {
            display: flex;
            height: calc(100vh - 120px);
        }

        .sidebar {
            width: 350px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .control-group {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }

        .control-group h3 {
            color: #2c3e50;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.25rem;
            transition: background 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn.satellite {
            background: #27ae60;
        }

        .btn.satellite:hover {
            background: #229954;
        }

        .legend {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            margin-right: 0.75rem;
            border: 2px solid #ddd;
        }

        .available { background-color: #27ae60; }
        .reserved { background-color: #f39c12; }
        .sold { background-color: #e74c3c; }

        .parcel-info {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .parcel-info h4 {
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .status-selector {
            margin: 1rem 0;
        }

        .status-selector select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .coordinates {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 0.5rem;
        }

        .floating-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 0.5rem;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .admin-mode {
            background: #e74c3c;
            color: white;
        }

        .admin-mode:hover {
            background: #c0392b;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
                order: 2;
            }
            
            .map-container {
                order: 1;
                height: calc(100vh - 320px);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1> Coral Subdivision</h1>
        <p>Premium Real Estate Development - Interactive Parcel Viewer</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="control-group">
                <h3> Map Controls</h3>
                <button class="btn" onclick="toggleBaseLayer()"> Street Map</button>
                <button class="btn satellite" onclick="toggleSatellite()"> Satellite View</button>
                <button class="btn" onclick="centerOnSubdivision()"> Center on Subdivision</button>
                <button class="btn" onclick="showMyLocation()"> My Location</button>
            </div>

            <div class="control-group">
                <h3> Parcel Status Legend</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color available"></div>
                        <span>Available for Sale</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color reserved"></div>
                        <span>Reserved</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color sold"></div>
                        <span>Sold</span>
                    </div>
                </div>
            </div>

            <div class="control-group">
                <h3> Admin Controls</h3>
                <button class="btn admin-mode" onclick="toggleAdminMode()">Admin Mode: OFF</button>
                <p style="font-size: 0.85rem; color: #7f8c8d; margin-top: 0.5rem;">
                    Enable admin mode to edit parcel status
                </p>
            </div>

            <div id="parcel-details" class="parcel-info" style="display: none;">
                <h4>Selected Parcel</h4>
                <div id="parcel-content"></div>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="floating-controls">
                <button class="btn" onclick="shareLocation()" style="padding: 0.5rem;"> Share</button>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // Global variables
        let map;
        let parcelLayer;
        let currentBaseLayer = 'street';
        let adminMode = false;
        let selectedParcel = null;
        let userLocation = null;

        // Parcel status data (in real app, this would come from database)
        let parcelStatus = {
            'P80': { status: 'available', price: 45000, size: 448.61 },
            'P79': { status: 'available', price: 47000, size: 469.32 },
            'P78': { status: 'reserved', price: 46500, size: 465.14 },
            'P77': { status: 'available', price: 45800, size: 458.37 },
            'P76': { status: 'sold', price: 47000, size: 469.32 },
            'P75': { status: 'available', price: 48600, size: 485.95 }
        };

        // Initialize map
        function initMap() {
            // Create map centered on approximate location (will adjust when data loads)
            map = L.map('map').setView([6.5244, 7.4986], 16);

            // Street map layer
            const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ' OpenStreetMap contributors'
            });

            // Satellite layer
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: ' Esri, Maxar, Earthstar Geographics'
            });

            // Add default layer
            streetLayer.addTo(map);
            
            // Store layers for switching
            window.mapLayers = {
                street: streetLayer,
                satellite: satelliteLayer
            };

            // Load and display parcels
            loadParcels();
        }

        // Load parcel data
        async function loadParcels() {
            try {
                const response = await fetch('./Coral_Parcels.geojson');
                const geojsonData = await response.json();
                
                // Create parcel layer with styling
                parcelLayer = L.geoJSON(geojsonData, {
                    style: function(feature) {
                        const parcelId = feature.properties.Text;
                        const status = parcelStatus[parcelId]?.status || 'available';
                        
                        return {
                            fillColor: getStatusColor(status),
                            weight: 2,
                            opacity: 1,
                            color: 'white',
                            dashArray: '3',
                            fillOpacity: 0.7
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const parcelId = feature.properties.Text;
                        const status = parcelStatus[parcelId] || { status: 'available', price: 0, size: feature.properties.Shape_Area };
                        
                        // Popup content
                        const popupContent = `
                            <div style="min-width: 200px;">
                                <h3 style="margin: 0 0 10px 0; color: #2c3e50;">Parcel ${parcelId}</h3>
                                <p><strong>Status:</strong> <span style="color: ${getStatusColor(status.status)}; text-transform: capitalize;">${status.status}</span></p>
                                <p><strong>Size:</strong> ${status.size.toFixed(2)} sq m</p>
                                <p><strong>Price:</strong> ${status.price.toLocaleString()}</p>
                                <p style="font-size: 0.9rem; color: #7f8c8d; margin-top: 10px;">
                                    Click parcel for details
                                </p>
                            </div>
                        `;
                        
                        layer.bindPopup(popupContent);
                        
                        // Click event
                        layer.on('click', function(e) {
                            selectParcel(parcelId, feature, layer);
                        });
                        
                        // Hover effects
                        layer.on('mouseover', function(e) {
                            layer.setStyle({
                                weight: 4,
                                color: '#2c3e50',
                                dashArray: '',
                                fillOpacity: 0.9
                            });
                        });
                        
                        layer.on('mouseout', function(e) {
                            parcelLayer.resetStyle(layer);
                        });
                    }
                }).addTo(map);
                
                // Fit map to parcels
                map.fitBounds(parcelLayer.getBounds(), { padding: [20, 20] });
                
            } catch (error) {
                console.error('Error loading parcels:', error);
                alert('Error loading parcel data. Please check if Coral_Parcels.geojson is in the same directory.');
            }
        }

        // Get color for parcel status
        function getStatusColor(status) {
            switch(status) {
                case 'available': return '#27ae60';
                case 'reserved': return '#f39c12';
                case 'sold': return '#e74c3c';
                default: return '#95a5a6';
            }
        }

        // Select parcel for details/editing
        function selectParcel(parcelId, feature, layer) {
            selectedParcel = { id: parcelId, feature: feature, layer: layer };
            
            const status = parcelStatus[parcelId] || { status: 'available', price: 0, size: feature.properties.Shape_Area };
            
            let content = `
                <h4>Parcel ${parcelId}</h4>
                <p><strong>Size:</strong> ${status.size.toFixed(2)} sq m</p>
                <p><strong>Current Status:</strong> <span style="color: ${getStatusColor(status.status)}; text-transform: capitalize;">${status.status}</span></p>
                <p><strong>Price:</strong> ${status.price.toLocaleString()}</p>
            `;
            
            if (adminMode) {
                content += `
                    <div class="status-selector">
                        <label><strong>Update Status:</strong></label>
                        <select id="status-select" onchange="updateParcelStatus()">
                            <option value="available" ${status.status === 'available' ? 'selected' : ''}>Available</option>
                            <option value="reserved" ${status.status === 'reserved' ? 'selected' : ''}>Reserved</option>
                            <option value="sold" ${status.status === 'sold' ? 'selected' : ''}>Sold</option>
                        </select>
                    </div>
                    <div style="margin-top: 10px;">
                        <label><strong>Price ():</strong></label>
                        <input type="number" id="price-input" value="${status.price}" onchange="updateParcelPrice()" style="width: 100%; padding: 5px; margin-top: 5px;">
                    </div>
                `;
            }
            
            document.getElementById('parcel-content').innerHTML = content;
            document.getElementById('parcel-details').style.display = 'block';
        }

        // Update parcel status
        function updateParcelStatus() {
            if (!selectedParcel) return;
            
            const newStatus = document.getElementById('status-select').value;
            const parcelId = selectedParcel.id;
            
            // Update status
            if (!parcelStatus[parcelId]) {
                parcelStatus[parcelId] = { status: 'available', price: 0, size: selectedParcel.feature.properties.Shape_Area };
            }
            parcelStatus[parcelId].status = newStatus;
            
            // Update layer style
            selectedParcel.layer.setStyle({
                fillColor: getStatusColor(newStatus),
                weight: 2,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            });
            
            // Update popup
            const status = parcelStatus[parcelId];
            const popupContent = `
                <div style="min-width: 200px;">
                    <h3 style="margin: 0 0 10px 0; color: #2c3e50;">Parcel ${parcelId}</h3>
                    <p><strong>Status:</strong> <span style="color: ${getStatusColor(status.status)}; text-transform: capitalize;">${status.status}</span></p>
                    <p><strong>Size:</strong> ${status.size.toFixed(2)} sq m</p>
                    <p><strong>Price:</strong> ${status.price.toLocaleString()}</p>
                </div>
            `;
            selectedParcel.layer.setPopupContent(popupContent);
            
            console.log(`Parcel ${parcelId} status updated to: ${newStatus}`);
        }

        // Update parcel price
        function updateParcelPrice() {
            if (!selectedParcel) return;
            
            const newPrice = parseFloat(document.getElementById('price-input').value) || 0;
            const parcelId = selectedParcel.id;
            
            if (!parcelStatus[parcelId]) {
                parcelStatus[parcelId] = { status: 'available', price: 0, size: selectedParcel.feature.properties.Shape_Area };
            }
            parcelStatus[parcelId].price = newPrice;
            
            console.log(`Parcel ${parcelId} price updated to: ${newPrice.toLocaleString()}`);
        }

        // Toggle base layer
        function toggleBaseLayer() {
            if (currentBaseLayer === 'street') {
                map.removeLayer(window.mapLayers.street);
                map.addLayer(window.mapLayers.satellite);
                currentBaseLayer = 'satellite';
                event.target.textContent = ' Satellite View';
                event.target.className = 'btn satellite';
            } else {
                map.removeLayer(window.mapLayers.satellite);
                map.addLayer(window.mapLayers.street);
                currentBaseLayer = 'street';
                event.target.textContent = ' Street Map';
                event.target.className = 'btn';
            }
        }

        // Toggle satellite view
        function toggleSatellite() {
            toggleBaseLayer();
        }

        // Center on subdivision
        function centerOnSubdivision() {
            if (parcelLayer) {
                map.fitBounds(parcelLayer.getBounds(), { padding: [20, 20] });
            }
        }

        // Show user location
        function showMyLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    userLocation = [lat, lng];
                    
                    // Add or update user location marker
                    if (window.userMarker) {
                        map.removeLayer(window.userMarker);
                    }
                    
                    window.userMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'user-location-marker',
                            html: '<div style="background: #3498db; width: 15px; height: 15px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);"></div>',
                            iconSize: [21, 21],
                            iconAnchor: [10.5, 10.5]
                        })
                    }).addTo(map);
                    
                    window.userMarker.bindPopup('<strong> Your Location</strong>');
                    
                    // Zoom to user location
                    map.setView([lat, lng], 17);
                    
                }, function(error) {
                    alert('Unable to get your location. Please enable location services.');
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        // Toggle admin mode
        function toggleAdminMode() {
            adminMode = !adminMode;
            const btn = event.target;
            
            if (adminMode) {
                btn.textContent = 'Admin Mode: ON';
                btn.style.background = '#27ae60';
                alert('Admin mode enabled! Click on parcels to edit their status.');
            } else {
                btn.textContent = 'Admin Mode: OFF';
                btn.style.background = '#e74c3c';
                document.getElementById('parcel-details').style.display = 'none';
                selectedParcel = null;
            }
        }

        // Share location
        function shareLocation() {
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Coral Subdivision - Real Estate',
                    text: 'Check out this premium subdivision with available parcels!',
                    url: url
                });
            } else {
                // Fallback for browsers that don't support Web Share API
                navigator.clipboard.writeText(url).then(function() {
                    alert('Link copied to clipboard! Share this link with potential buyers.');
                }).catch(function() {
                    prompt('Copy this link to share:', url);
                });
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
        });
    </script>
</body>
</html>
